AUI.add("aui-uploader",function(p){var f=p.Lang,a=f.isFunction,j=p.getClassName,h="uploaderdd",l="input[type=file]",t=j("helper","hidden"),q=j(h,"drop","node"),n=j(h,"drop","node","over"),o=j(h,"html"),i=j(h,"image"),c=j(h,"label"),k='<div class="'+[q,t].join(" ")+'"></div>',s='<{0} id="{1}" class="'+o+'"><form></form></{0}>',d='<div id="{0}" class="'+i+'"><a href="javascript://"><form></form></a></div>',r='<label class="'+c+'"><input type="file" {0} /></label>',m="#{0} a [ width: {2}px; height: {3}px; background: url({1}) 0 0 no-repeat; ]"+"#{0} a:hover [ background-position: 0 -{3}px; ]"+"#{0} a:active [ background-position: 0 -{4}px; ]",u="--{0}--",b="--{0}\r\n"+'Content-Disposition: form-data; name="{1}"\r\n'+"\r\n{2}\r\n",e="--{0}\r\n"+'Content-Disposition: form-data; name="{1}"; filename="{2}"\r\n'+"Content-Type: application/octet-stream\r\n";var g=p.Component.create({NAME:h,EXTENDS:p.Uploader,ATTRS:{container:{value:null},disableXHR:{value:false,writeOnce:"initOnly"},fileFilters:{value:[],setter:function(C){var v=this;var B=C;var w=[];if(B){for(var z=0;z<B.length;z++){var A=B[z].extensions;if(A){A=A.split(";");for(var y=0;y<A.length;y++){var x=f.trim(A[y]);if(x.length){x=x.replace(/\./g,"\\.");x=x.replace(/\*/g,"(.*?)");x="^"+x+"$";w.push(x);}}}}}v._fileFiltersRegExp=(w.length?w:null);g.superclass.setFileFilters.apply(v,arguments);return C;}},fileList:{value:{}},filePostName:{value:null},fileSizeLimit:{value:null},generateNewId:{value:false},strings:{}},constructor:function(w){var v=this;if(w.boundingBox){v._content=p.one(w.boundingBox).cloneNode(true);}g.superclass.constructor.apply(v,arguments);},prototype:{initializer:function(){var v=this;v.set("container",p.one(v.get("boundingBox")));var z=v.uploaderswf;var x=z._swfId||z._id;v._swf=p.one("#"+x);if(v.canSupportXHR()&&!v.get("disableXHR")){v._renderFileSelect();v._initializeUploader();}else{if(!v.get("buttonSkin")){var w=v.get("container");w.append(v._content.html());w.addClass(o);var y=v._swf;y.setStyle("width",w.get("offsetWidth"));y.setStyle("height",w.get("offsetHeight"));v._bindMouseEvents(w);}v.on("fileselect",v._onFileSelect,v);v.on(["uploadcomplete","uploaderror","uploadcancel"],v._onUploadComplete,v);}v._xhr={};v._queueList=[];v._totalFileCount=0;},cancel:function(w){var v=this;if(v._isSwfVisible()){return g.superclass.cancel.apply(v,arguments);}else{if(v._xhr[w]){v._xhr[w].abort();return true;}return false;}},cancelAll:function(){var v=this;var y=0;if(v._isSwfVisible()){var w=v.get("fileList");for(var x in w){v.cancel(x);y++;}}else{v._queueList=[];for(var x in v._xhr){v._xhr[x].abort();y++;}}return y;},canSupportDD:function(){var v=this;return("draggable" in document.createElement(v.get("container").get("tagName")));},canSupportXHR:function(){var v=this;return(window.XMLHttpRequest&&window.FileReader);},clearFileList:function(){var v=this;v.set("fileList",{});return g.superclass.clearFileList.apply(v,arguments);},disable:function(){var v=this;var w=v._fileSelect;if(w){w.all(l).attr("disabled",true);}return g.superclass.disable.apply(v,arguments);},enable:function(){var v=this;var w=v._fileSelect;if(w){w.all(l).attr("disabled",false);}return g.superclass.enable.apply(v,arguments);},removeFile:function(w){var v=this;var x=v.get("fileList");delete x[w];if(v._isSwfVisible()){return g.superclass.removeFile.apply(v,arguments);}},upload:function(y,x,v,B,G){var C=this;if(C._isSwfVisible()){g.superclass.upload.apply(C,arguments);}else{var D=C.get("fileList");var z=D[y]||C._getQueuedById(y);if(C._xhr[y]){C._removeFile(z);return true;}if(z){var F=C.get("simLimit");var w=C._getXHRCount();if(w<F){var E=new XMLHttpRequest();E._uploaderDD={file:z,fileId:y,fileName:G,instance:C,postVars:B};C._xhr[y]=E;E.addEventListener("readystatechange",p.bind(C._doReadyStateChangeXHR,E),false);E.upload.addEventListener("progress",p.bind(C._doProgressXHR,E),false);E.upload.addEventListener("error",p.bind(C._doErrorXHR,E),false);E.upload.addEventListener("abort",p.bind(C._doAbortXHR,E),false);E.upload.addEventListener("load",p.bind(C._doLoadXHR,E),false);E.open((v?v:"POST"),x,true);var A=new FileReader();if(a(A.addEventListener)){A.addEventListener("loadend",p.bind(C._doLoadEndXHR,E),false);}else{A.onloadend=p.bind(C._doLoadEndXHR,E);}A.readAsBinaryString(z);C._removeFile(z);C.fire("uploadstart",{id:y,type:"uploadstart"});}else{if(C._getQueueIndex(y)==-1){C._queueList.push({arguments:arguments,file:z,id:y});}}delete D[y];return true;}}return false;},uploadAll:function(z,B,x,A){var v=this;if(v._isSwfVisible()){return g.superclass.uploadAll.apply(v,arguments);}else{var y=v.get("fileList");for(var w in y){v.upload(w,z,B,x,A);}return true;}},uploadThese:function(y,x,B,w,A){var v=this;if(v._isSwfVisible()){return g.superclass.uploadThese.apply(v,arguments);}else{if(y){for(var z=0;z<y.length;z++){v.upload(y[z],x,B,w,A);}}return true;}return false;},_addFile:function(F){var D=this;var A=true;if(F instanceof File){var E=D.get("fileList");var w=D._getFileCount();if(D.get("multiFiles")||w==0){var v="file"+(D.get("generateNewId")?D._getNewId():w);var G=false;var C=D._fileFiltersRegExp;if(C){var x=F.name;for(var y=0;y<C.length;y++){var B=new RegExp(C[y],"gi");if(B.test(x)){G=true;break;}}}else{G=true;}if(G){var z=D.get("fileSizeLimit");if(!z||F.size<=z){while(E[v]||D._getQueueIndex(v)!=-1){w++;v="file"+w;}F.id=v;E[v]=F;D._totalFileCount++;A=false;}else{D.fire("filesizeerror",{file:F,type:"filesizeerror"});}}}}return A;},_appendInputFile:function(y){var v=this;var w=v._fileSelect;var z=w.one("form");var x=p.Node.create(f.sub(r,[(v.get("multiFiles")?'multiple="true"':"")]));if(y){x.setStyle("width",y);}z.append(x);},_bindMouseEvents:function(w){var v=this;var x=p.bind(v._fireEvent,v);w.on("click",x);w.on("mousedown",x);w.on("mouseup",x);w.on("mouseleave",x);w.on("mouseenter",x);},_doAbortXHR:function(z){var v=this;var A=v;var y=A._uploaderDD;var w=y.fileId;var x=y.file;v=y.instance;v._removeXHR(w);v.fire("uploadcancel",{fileName:y.fileName||y.file.name,id:w,type:"uploadcancel"});
v._sendQueued();},_doErrorXHR:function(z){var v=this;var A=v;var y=A._uploaderDD;var w=y.fileId;var x=y.file;v=y.instance;v._removeXHR(w);v.fire("uploaderror",{fileName:y.fileName||y.file.name,id:w,type:"uploaderror"});v._sendQueued();},_doLoadEndXHR:function(v){var F=this;var G=F;var x=G._uploaderDD;var C=x.fileName;var A=x.postVars;var H=v.currentTarget.result;var w=a(G.sendAsBinary);var B=[];F=x.instance;var y="__"+new Date().getTime()+"__";if(A){for(var D in A){B.push(f.sub(b,[y,D,A[D]]));}}if(!w){H=btoa(H);}var z=F.get("filePostName");if(z==null||z==""){z=x.fileId;}B.push(f.sub(e,[y,z,(C!=null?C:x.file.name)]));B.push("\r\n");B.push(H);B.push("\r\n");B.push(f.sub(u,[y]));G.setRequestHeader("Content-Type","multipart/form-data; boundary="+y);var E=B.join("");if(w){G.sendAsBinary(E);}else{G.send(E);}},_doLoadXHR:function(y){var v=this;var z=v;var x=z._uploaderDD;var w=x.fileId;v=x.instance;v._removeXHR(w);v.fire("uploadcomplete",{fileName:x.fileName||x.file.name,id:w,type:"uploadcomplete"});v._sendQueued();},_doProgressXHR:function(A){var v=this;if(A.lengthComputable){var B=v;var y=B._uploaderDD;var w=y.fileId;v=y.instance;var x=A.loaded;var z=A.total;v.fire("uploadprogress",{bytesLoaded:x,bytesTotal:z,fileName:y.fileName||y.file.name,percentage:Math.round((100*x/z)),id:w,type:"uploadprogress"});}},_doReadyStateChangeXHR:function(v){var C=this;var D=C;var w=D._uploaderDD;var y=w.fileId;var B=v.currentTarget;var z=w.file;C=w.instance;if(B.readyState==4){var A=B.status;var x=(B.responseXML!=null?B.responseXML:B.responseText);if((A>=200&&A<300)||A===1223){if(x!=null){C.fire("uploadcompletedata",{data:x,fileName:w.fileName||w.file.name,id:y,status:A,type:"uploadcompletedata"});}}else{p.setTimeout(function(){C.fire("uploaderror",{data:x,fileName:w.fileName||w.file.name,id:y,status:A,type:"uploaderror"});},0);}}},_fireEvent:function(w){var v=this;v.fire(w.type,w);},_getFileCount:function(){var v=this;return v._getItemCount(v.get("fileList"));},_getItemCount:function(w){var v=this;var y=0;if(w){for(var x in w){y++;}}return y;},_getQueuedById:function(x){var w=this;var v=w._queueList;var y=w._getQueueIndex(x);return(y!=-1?v[y].file:null);},_getQueueIndex:function(x){var w=this;var v=w._queueList;for(var y=0;y<v.length;y++){if(v[y].id==x){return y;}}return -1;},_getQueueLength:function(){var w=this;var v=w._queueList;var y=0;if(v){for(var x=0;x<v.length;x++){if(!v[x].sent){y++;}}}return y;},_getNewId:function(){var v=this;return v._totalFileCount;},_getXHRCount:function(){var v=this;return v._getItemCount(v._xhr);},_isSwfVisible:function(){var v=this;var w=v._swf;return(w?!w.hasClass(t):false);},_onDragEnter:function(w){var v=this;w.halt();v._dropNode.show();v.fire("dragenter",w);},_onDragLeave:function(w){var v=this;v._dropNode.removeClass(n);v.fire("dragleave",w);},_onDragOver:function(w){var v=this;w.halt();v._dropNode.addClass(n);v._dropNodeHideTask.delay(50);v.fire("dragover",w);},_onDrop:function(z){var w=this;z.halt();w._dropNodeHideTask.delay(0);var v=z._event;if(v.dataTransfer){var y=v.dataTransfer.files;if(y){for(var x=0;x<y.length;x++){w._addFile(y[x]);}}w.fire("fileselect",{fileList:w.get("fileList")});}w.fire("drop",z);},_onFileSelect:function(y){var v=this;var w=v.get("fileList");var z=y.fileList;for(var x in z){w[x]=z[x];}},_onUploadComplete:function(y){var v=this;var w=y.id;var x=v.get("fileList");delete x[w];v.removeFile(w);},_removeFile:function(A){var v=this;var y=v.get("fileList");for(var z in y){if(y[z]==A){delete y[z];break;}}if(v._queueList.length){var x=v._getQueueIndex(A.id);var w=true;v._queueList[x].sent=true;for(var z=0;z<v._queueList.length;z++){if(!v._queueList[z].sent){w=false;break;}}if(w){v._queueList=[];}}},_removeXHR:function(w){var v=this;delete v._xhr[w];},_renderFileSelect:function(){var N=this;if(!N._fileSelect){var G=N.get("container");var y=N.get("buttonSkin");var L=p.guid();var B;var z;var I;if(y){z=p.Node.create(f.sub(d,[L]));G.append(z);var w=G.get("offsetHeight");var P=f.sub(m,[L,y,G.get("offsetWidth"),w,(w*2)]);P=P.replace(/\[/g,"{");P=P.replace(/\]/g,"}");var M=new p.StyleSheet(P);B=G;I=B.get("offsetWidth");}else{var O=(G.getComputedStyle("display")=="block"?"div":"span");z=p.Node.create(f.sub(s,[O,L]));var D=G.ancestor();D.insert(z,G);G.append(N._content.html());z.append(G);B=z;I=G.get("offsetWidth");}N._fileSelect=z;N._toggleSwf(false);var K=N.get("multiFiles");var v=z.one("form");var w=B.get("offsetHeight");N._appendInputFile(I);var F=v.one("input");var J=F.get("offsetWidth")-30;var H=F.get("offsetHeight")/2;var A=[];G.on("mousemove",function(Q){A[0]=Q.pageX-J;A[1]=Q.pageY-H;F.setXY(A);});F.on("change",function(R){var Q=R.currentTarget.attr("files");p.some(Q.getDOM(),N._addFile,N);N.fire("fileselect",{fileList:N.get("fileList")});});N.publish("dragenter");N.publish("dragover");N.publish("dragleave");N.publish("drop");N.publish("fileselect");N.publish("uploadprogress");N.publish("uploadcomplete");N.publish("uploadcompletedata");N.publish("uploaderror");N.publish("uploadcancel");N.publish("uploadstart");N.publish("filesizeerror");N.publish("click");N.publish("mousedown");N.publish("mouseup");N.publish("mouseleave");N.publish("mouseenter");N._bindMouseEvents(B);if(N.canSupportDD()){var x=N._dropNode=p.Node.create(k);var E=p.getBody();x.setContent(N.get("strings.DROP_MESSAGE"));E.prepend(x);E.on("dragenter",N._onDragEnter,N);E.on("dragleave",N._onDragLeave,N);N._dropNodeHideTask=new p.DelayedTask(x.hide,x);var C=N._stopDragging;E.on("dragover",C,N);E.on("drop",C,N);x.on("dragover",N._onDragOver,N);x.on("drop",N._onDrop,N);}}},_sendQueued:function(){var w=this;var v=w._queueList;for(var x=0;x<v.length;x++){if(!v[x].sent){w.upload.apply(w,v[x].arguments);}}},_stopDragging:function(w){var v=this;w.preventDefault();w.stopPropagation();v._dropNodeHideTask.delay(50);},_toggleSwf:function(x){var v=this;var y=v._swf;if(y){var w=v._fileSelect;if(x==null){x=!v._isSwfVisible();}v.clearFileList();if(x){y.show();if(w){w.hide();}}else{if(w){y.hide();w.show();}}}},}});
p.UploaderDD=g;},"@VERSION@",{requires:["aui-base","aui-task-manager","stylesheet","uploader"],skinnable:true});